<link rel="import" href="../polymer/polymer.html"> <dom-module id="simpla-admin"> <template> <style>:host{position:absolute}:host([hidden]),[hidden]{display:none!important}</style> <simpla-admin-controls editable="[[_editable]]" authenticated="[[_authenticated]]" busy="{{busy}}" on-login="login" on-save="save" hidden$="[[_loginOpen]]"> </simpla-admin-controls> <simpla-login id="login" active="{{_loginOpen}}"> </simpla-login> <simpla-notify></simpla-notify> </template> <script>!function(){"use strict";function e(e){var t=!!Simpla.getState("buffer");if(t)return e.returnValue=s,s}function t(e){e.keyCode===d.edit&&e[u]&&(e.preventDefault(),Simpla.editable(!Simpla.getState("editable")))}function i(e){e.keyCode===d.save&&e[u]&&(e.preventDefault(),document.querySelector("simpla-admin").save())}function n(e){var t=document.querySelector("simpla-admin"),i=void 0;e&&!t&&(i=document.createElement("simpla-admin"),document.body.appendChild(i))}function a(){var e=window.location.hash===m;Simpla.editable(e)}function o(e){window.location.hash=e?m:""}var r={properties:{loginPrompt:{type:Boolean,observer:"_toggleLoginPromptObserver"}},_toggleLoginPromptObserver:function(e){var t=this,i=this._simplaObservers,n=function(e){var i=t.$.login,n=new Promise(function e(t){"function"==typeof i.prompt?t():setTimeout(e.bind(null,t),10)});n.then(function(){e&&!t._authenticated&&i.prompt().then(function(e){Simpla.editable(e)})})};e?(n(Simpla.getState("editable")),i.login=Simpla.observeState("editable",n)):i.login&&i.login.unobserve()}},s="You have unsaved changes, are you sure you want to leave?",l={attached:function(){window.addEventListener("beforeunload",e)},detached:function(){window.removeEventListener("beforeunload",e)}},u="metaKey",d={edit:69,save:83},c={properties:{hotkeys:Boolean},observers:["_updateEditableListener(_authenticated, hotkeys)","_updateSaveListener(_editable, hotkeys)"],_updateEditableListener:function(e,i){e&&i?document.addEventListener("keydown",t):document.removeEventListener("keydown",t)},_updateSaveListener:function(e,t){e&&t?document.addEventListener("keydown",i):document.removeEventListener("keydown",i)},detached:function(){document.removeEventListener("keydown",t),document.removeEventListener("keydown",i)}},v={_simplaObservers:[],observe:function(){var e=Simpla.getState(),t=e.editable,i=e.authenticated,a=t||i;n(a),this._simplaObservers=[Simpla.observeState("authenticated",n),Simpla.observeState("editable",n)]},unobserve:function(){this._simplaObservers.forEach(function(e){return e.unobserve()}),this._simplaObservers=[]}},m="#edit",h={_simplaObserver:null,_tracking:!1,track:function(){a(),this._tracking||(window.addEventListener("hashchange",a),o(Simpla.getState("editable")),this._simplaObserver=Simpla.observeState("editable",o),this._tracking=!0)},untrack:function(){this._tracking&&(window.removeEventListener("hashchange",a),this._simplaObserver&&this._simplaObserver.unobserve(),this._simplaObserver=null,this._tracking=!1)}},p=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},b=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),f=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},y=["../simpla-login/simpla-login.html","../simpla-notify/simpla-notify.html","simpla-admin-controls.html"],_={saved:"changes saved",saveFailed:"something went wrong, try again?"},g={hashTracking:!0,loginPrompt:!0,hotkeys:!0};window.SimplaAdmin=f({},g,window.SimplaAdmin),v.observe(),window.SimplaAdmin.hashTracking&&h.track();var k=function(){function e(){p(this,e)}return b(e,[{key:"beforeRegister",value:function(){this.is="simpla-admin",this.properties={hashTracking:{type:Boolean,observer:"_updateHashTracking"},hidden:{type:Boolean,reflectToAttribute:!0},busy:{type:Boolean,value:!1},_editable:Boolean,_authenticated:Boolean,_dependenciesImported:Boolean,_loginOpen:Boolean,_simplaObservers:{type:Object,value:{}}},this.observers=["_toggleHidden(_editable, _authenticated)","_disableEditable(busy)"]}},{key:"ready",value:function(){f(this,window.SimplaAdmin),window.SimplaAdmin=this}},{key:"attached",value:function(){this._importDependencies(),this._syncEditableAndAuthenticated()}},{key:"detached",value:function(){var e=this;Object.keys(this._simplaObservers).forEach(function(t){e._simplaObservers[t].unobserve()}),this._simplaObservers={},h.untrack(),v.unobserve()}},{key:"_disableEditable",value:function(e){e&&Simpla.getState("editable")?(h.untrack(),Simpla.editable(!1),this.__busyDisabled=!0):!e&&this.__busyDisabled&&(Simpla.editable(!0),h.track(),this.__busyDisabled=!1)}},{key:"login",value:function(){this.$.login.open()}},{key:"save",value:function(){var e=this,t=function(){e.busy=!1,e.fire("simpla-notification",{text:_.saved})},i=function(){e.busy=!1,e.fire("simpla-notification",{text:_.saveFailed})};this.busy=!0,Simpla.save().then(t).catch(i)}},{key:"_toggleHidden",value:function(e,t){this.hidden=!e&&!t}},{key:"_updateHashTracking",value:function(e){e?h.track():h.untrack()}},{key:"_syncEditableAndAuthenticated",value:function(){var e=this,t=Simpla.getState(),i=t.editable,n=t.authenticated,a=function(t){return e._editable=t},o=function(t){return e._authenticated=t};a(i),o(n),this._simplaObservers.editable=Simpla.observeState("editable",a),this._simplaObservers.authenticated=Simpla.observeState("authenticated",o)}},{key:"_importDependencies",value:function(){var e=this;y.forEach(function(t){e.importHref(e.resolveUrl(t))})}},{key:"behaviors",get:function(){return[r,c,l]}}]),e}();Polymer(k),window.HashTracking=h}()</script> </dom-module> 